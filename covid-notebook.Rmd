---
title: 'Covid data'
output:
    html_document:
        code_folding: hide
        toc: true
        toc_float: true
        toc_depth: 3
---

```{r global_options}
knitr::opts_chunk$set(warning=FALSE, message=FALSE,
                      fig.width=8.5, fig.height=6)
```

```{r lib}
library(ggplot2)
library(readr)
library(dplyr)
library(purrr)
library(tidyr)
library(hexbin)
library(plotly)
library(maps)
```

```{r data_location}
# Location of data (git repo with JHU data)
data.dir <- '~/workspace/r-stuff/COVID-19/csse_covid_19_data/csse_covid_19_time_series'

# files to be used in this analysis
file.list <- list(US=list(confirmed='time_series_covid19_confirmed_US.csv',
                           deaths='time_series_covid19_deaths_US.csv'),
                   Global=list(confirmed='time_series_covid19_confirmed_global.csv',
                           deaths='time_series_covid19_deaths_global.csv'))

# file name to get time stamp
last.downloaded <- file.info(file.path(data.dir, file.list[[1]][[1]]))$ctime
```

The data used in this analysis was downloaded on: *`r last.downloaded`*

This analysis was last run on: *`r Sys.Date()`*

```{r read_data}
data.list <- list()
for(name in names(file.list)){
    data.list[[name]] <- list()
    for(type in names(file.list[[name]])){
        data.list[[name]][[type]] <- read_csv(file.path(data.dir, 
                                                        file.list[[name]][[type]]))
    }
}
```

```{r state_wide}
# Here we add all the rows for a particular state
state.time <- list()
name <- 'US'
for(type in names(data.list[[name]])){
    df <- data.list[[name]][[type]]
    state.time[[type]] <- df %>% 
        group_by(Province_State) %>% 
        select(contains('20')) %>% 
        summarize_each(funs=sum)

}
```

```{r province_data}
# Here we get the total deaths/cases for any province
# For this we take the last column from the original data
district.total <- list()
for(name in names(data.list)){
    district.total[[name]] <- tibble()
    for(type in names(data.list[[name]])){
        df <- data.list[[name]][[type]]
        # last column has the total
        total <- df[,dim(df)[2]]

        df2 <- df %>% select(-contains('20'))
        if(nrow(district.total[[name]]) == 0){
            district.total[[name]] <- df2
        } else {
            cols.to.add <- names(df2)[!names(df2) %in% names(district.total[[name]])]
            district.total[[name]] <- bind_cols(district.total[[name]],
                                           df2 %>% select(all_of(cols.to.add)))
        }
        district.total[[name]][,type] <- total
    }
}

```

# US data

## Death rate by day

Here we plot the total death rate starting from where confirmed cases rose above
1000.

```{r}

total.confirmed <- state.time[['confirmed']] %>%
    select(-Province_State) %>% summarise_all(sum)
total.deaths <- state.time[['deaths']] %>%
    select(-Province_State) %>% summarise_all(sum)
df <- data.frame(row.names=NULL,
                 date=as.Date(names(total.confirmed), format='%m/%d/%y'),
                 confirmed=t(total.confirmed),
                 deaths=t(total.deaths),
                 death.rate=t(total.deaths/total.confirmed))

xmin <- which(df$confirmed > 1000)[1]
xmax <- dim(df)[1]

text_y <- paste('confirmed = ', df$confirmed, '; deaths = ', df$deaths)
p <- df  %>% filter(confirmed > 1000) %>% ggplot(aes(date, death.rate)) + 
    geom_point(aes(size=confirmed), alpha=0.7) + 
    geom_line(linetype='dotted', alpha=0.5) + theme_bw() +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank())
ggplotly(p)

```

## District level

```{r}
# NOTE: x-axis limits
xmax <- -67
xmin <- -125

# NOTE: y-axis limits
ymin <- 25
ymax <- 50

df <- district.total[['US']]

top.by.state <- list(confirmed=df %>% group_by(Province_State) %>% top_n(1, confirmed),
                     deaths=df %>% group_by(Province_State) %>% top_n(1, deaths))
```

<!--
### Density of cases {.tabset}

Density of provinces with at least one confirmed case or death so far.
-->

```{r density_plots, results='asis', eval=FALSE}
p <- df %>% filter(confirmed > 0) %>%
    ggplot(aes(x=Long_, y=Lat)) +
    stat_density_2d(aes(fill=after_stat(level)), geom='polygon',  alpha=0.5) +
    scale_fill_continuous(type='viridis') + 
    geom_point(alpha=0.1) + xlim(xmin, xmax) + ylim(ymin, ymax) + theme_bw() +
    scale_color_continuous(type='viridis') +
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())

cat('#### confirmed\n')
p
cat('\n\n')

p <- df %>% filter(deaths > 0) %>%
    ggplot(aes(x=Long_, y=Lat)) +
    stat_density_2d(aes(fill=after_stat(level)), geom='polygon',  alpha=0.5) +
    scale_fill_continuous(type='viridis') +
    geom_point(alpha=0.1) + xlim(xmin, xmax) + ylim(ymin, ymax) + theme_bw() +
    scale_color_continuous(type='viridis') +
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())

cat('#### deaths\n')
p
cat('\n\n')

```

<!--
### Totals in each district (dots) {.tabset}
-->

```{r map_plots, results='asis', eval=FALSE}
df <- district.total[['US']]
cols <- list('confirmed' = 'darkblue',
             'deaths' = 'darkred')

p.list <- list()
for(type in c('confirmed','deaths')){
    p.list[[type]] <- ggplot(df,  aes_string(x='Long_', y='Lat', size=type)) +
        geom_point(alpha=0.2, color=cols[[type]]) + 
        xlim(xmin, xmax) + ylim(ymin, ymax) + theme_bw() +
        scale_size_continuous(trans='log10',name = type) +
        theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())
}

cat('#### confirmed\n')
ggplotly(p.list[['confirmed']])
cat('\n\n')
cat('#### deaths\n')
ggplotly(p.list[['deaths']])
cat('\n\n')

```

### Totals in each district {.tabset}

```{r map_plots_area, results='asis', cache=TRUE}
counties <- map_data('county')

# filter by counties in map data
df2 <- district.total[['US']] %>%
    mutate(Admin2=tolower(Admin2)) %>%
    rename(subregion=Admin2) %>%
    filter(subregion %in% unique(counties$subregion))

# inner join by subregion
df2.counties <- inner_join(counties, df2)

cols <- list('confirmed' = 'Blues',
             'deaths' = 'Reds')

p.list <- list()
for(type in c('confirmed','deaths')){
    p.list[[type]] <- ggplot(df2.counties,
                             aes_string(x='long', y='lat', fill=type, text=type, group='group')) +
                        geom_polygon() +
                        scale_fill_gradientn(trans='log10', na.value='white',
                                             colors=RColorBrewer::brewer.pal(9, cols[[type]])) +
                        theme_bw() + 
                        theme(panel.grid.major=element_blank(),
                              panel.grid.minor=element_blank())
}

cat('#### confirmed\n')
ggplotly(p.list[['confirmed']], tooltip='text')
cat('\n\n')
cat('#### deaths\n')
ggplotly(p.list[['deaths']], tooltip='text')
cat('\n\n')
```

<!--
### Summarized density of cases {.tabset}
-->

```{r summarized_density, results='asis', eval=FALSE}
df2 <- top.by.state[['confirmed']] %>% arrange(-confirmed)
p <- ggplot(df, aes(x=Long_, y=Lat, z=confirmed)) +
    stat_summary_hex(binwidth=0.5, alpha=0.5, 
                     fun=function(x) log10(sum(x)), drop=TRUE) +
    scale_fill_continuous(type='viridis', na.value='white') + 
    xlim(xmin, xmax) + ylim(ymin, ymax) + theme_bw() +
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank()) +
    geom_point(data=df2[1:10,],
               aes(Long_, Lat, text=Combined_Key), size=2, color='red', shape=5)

cat('#### confirmed\n')
ggplotly(p, tooltip=c('z','text'))
cat('\n\n')

df2 <- top.by.state[['deaths']] %>% arrange(-deaths)
p <- ggplot(df, aes(x=Long_, y=Lat, z=deaths)) +
    stat_summary_hex(binwidth=0.5, alpha=0.5, 
                     fun=function(x) log10(sum(x)), drop=TRUE) +
    scale_fill_continuous(type='viridis', na.value='white') +
    xlim(xmin, xmax) + ylim(ymin, ymax) + theme_bw() +
    theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank()) +
    geom_point(data=df2[1:10,],
               aes(x=Long_, y=Lat, text=Combined_Key), size=2, color='red', shape=5)

cat('#### deaths\n')
ggplotly(p, tooltip=c('z', 'text'))
cat('\n\n')
```


## State level

### Total in each state {.tabset}

```{r map_plot_state, results='asis'}
usdata <- map_data('state')

state.counts <- district.total[['US']] %>%
    mutate(region=tolower(Province_State)) %>%
    filter(region %in% unique(usdata$region)) %>%
    group_by(region) %>%
    select(confirmed, deaths) %>%
    summarize_each(funs=sum)

state.counts.coords <- inner_join(usdata, state.counts)
#state.counts.coords <- state.counts.coords[order(state.counts.coords$order),]

#state.counts.coords <- district.total[['US']] %>%
#    group_by(Province_State) %>%
#    select(Long_, Lat) %>%
#    summarize_each(funs=mean) %>%
#    bind_cols(state.counts %>% select(-Province_State)) %>%
#    mutate(confirmed2 = log10(confirmed)) %>%
#    mutate(deaths2 = log10(deaths))

cols <- list(confirmed = 'Blues',
             deaths = 'Reds')

p.list <- list()
for(type in c('confirmed','deaths')){
    p.list[[type]] <- ggplot(state.counts.coords,
                             aes_string(x='long', y='lat', fill=type, text=type, group='group')) +
                        geom_polygon() +
                        scale_fill_gradientn(trans='log10', na.value='white',
                                             colors=RColorBrewer::brewer.pal(9, cols[[type]])) +
                        theme_bw() + 
                        theme(panel.grid.major=element_blank(),
                              panel.grid.minor=element_blank())
}

cat('#### confirmed\n')
ggplotly(p.list[['confirmed']], tooltip='text')
cat('\n\n')
cat('#### deaths\n')
ggplotly(p.list[['deaths']], tooltip='text')
cat('\n\n')

```
### Total numbers by date {.tabset}

```{r results='asis'}
p.list <- list()

state.time.longer <- list()
for(name in names(state.time)){
    df <- state.time[[name]]
    # add total row
    df2 <- df %>% summarize_if(is.numeric, sum)
    df <- rbind(df, cbind(Province_State='total', df2)) %>%
        pivot_longer(cols=contains('20')) %>% 
        mutate(date=as.Date(name, format='%m/%d/%y'))

    state.time.longer[[name]] <- df

    p.list[[name]] <- ggplot(df, aes(x=date, y=value,
                                     group=Province_State, color=Province_State)) +
                            geom_line() + theme_bw() + 
                            theme(panel.grid.major=element_blank(),
                                  panel.grid.minor=element_blank())
}

cat('#### linear {.tabset}\n')
cat('##### confirmed\n')
ggplotly(p.list[['confirmed']])
cat('\n\n')

cat('##### deaths\n')
ggplotly(p.list[['deaths']])
cat('\n\n')

cat('#### logarithmic {.tabset}\n')
cat('##### confirmed\n')
ggplotly(p.list[['confirmed']] + scale_y_log10())
cat('\n\n')

cat('##### deaths\n')
ggplotly(p.list[['deaths']] + scale_y_log10())
cat('\n\n')

```

### Daily increase {.tabset}

```{r results='asis'}
increase.time <- list()
for(name in names(state.time.longer)){
    increase.time[[name]] <- state.time.longer[[name]] %>%
        group_by(Province_State) %>%
        mutate(next_day=lead(value)) %>%
        mutate(increase=next_day - value) %>%
        select(-next_day)
}

p.list <- list()
for(name in names(increase.time)){
    p.list[[name]] <- increase.time[[name]] %>%
        ggplot(aes(date, increase, color=Province_State)) +
               geom_line() + theme_bw() +
               theme(panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
}

cat('#### linear {.tabset}\n')
cat('##### confirmed\n')
ggplotly(p.list[['confirmed']])
cat('\n\n')
cat('##### deaths\n')
ggplotly(p.list[['deaths']])
cat('\n\n')

cat('#### logarithmic {.tabset}\n')
cat('##### confirmed\n')
ggplotly(p.list[['confirmed']] + scale_y_log10() + geom_smooth(se=FALSE))
cat('\n\n')
cat('##### deaths\n')
ggplotly(p.list[['deaths']] + scale_y_log10())
cat('\n\n')
```

### Selected states

```{r states}
states.to.plot <- c('total','Washington', 'New York', 'California', 
                    'Michigan', 'Louisiana', 'Maryland')
knitr::kable(data.frame(states.to.plot))
```

#### Total numbers by date {.tabset}


```{r time_plots_linear, results='asis'}
p.list <- list()
for(name in names(state.time.longer)){
    df <- state.time.longer[[name]] %>% filter(Province_State %in% states.to.plot)
    p.list[[name]] <- ggplot(df, aes(x=date, y=value,
                                     group=Province_State, color=Province_State)) +
                            geom_line() + theme_bw() + 
                            theme(panel.grid.major=element_blank(),
                                  panel.grid.minor=element_blank())
}

cat('##### linear {.tabset}\n')
cat('###### confirmed\n')
ggplotly(p.list[['confirmed']])
cat('\n\n')
cat('###### deaths\n')
ggplotly(p.list[['deaths']])
cat('\n\n')

cat('##### logarithmic {.tabset}\n')
cat('###### confirmed\n')
ggplotly(p.list[['confirmed']] + scale_y_log10())
cat('\n\n')
cat('###### deaths\n')
ggplotly(p.list[['deaths']] + scale_y_log10())
cat('\n\n')
```

#### Daily increase {.tabset}


```{r results='asis'}
p.list <- list()
for(name in names(increase.time)){
    p.list[[name]] <- increase.time[[name]] %>%
        filter(Province_State %in% states.to.plot) %>%
        ggplot(aes(date, increase, color=Province_State)) +
               geom_line() + theme_bw() +
               theme(panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
}

cat('##### linear {.tabset}\n')
cat('###### confirmed\n')
ggplotly(p.list[['confirmed']])
cat('\n\n')

cat('###### deaths\n')
ggplotly(p.list[['deaths']])
cat('\n\n')

cat('##### logarithmic {.tabset}\n')
cat('###### confirmed\n')
ggplotly(p.list[['confirmed']] + scale_y_log10())
cat('\n\n')

cat('###### deaths\n')
ggplotly(p.list[['deaths']] + scale_y_log10())
cat('\n\n')
```


# sessionInfo

```{r collapse=FALSE}
sessionInfo()
```
